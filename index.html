<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Asana</title>
    <!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  </head>
  <body>

    <div id='signin'></div>

    <div id='cfps'>
      <table class='table'>
        <thead>
          <tr><th>Open</th><th>Title</th><th>When</th><th>Count</th></tr>
        </thead>
        <tbody id='cfplist'>

        </tbody>
      </table>
    </div>
    <form name="myForm" action="/action_page.php" onsubmit="return validateForm()" method="post">
    Name: <input type="text" name="fname">
    <input type="submit" value="Submit">
    </form>
    <!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  <script>
    //const asana = require('asana');

function getTask(gid) {
  console.log("gid="+gid);
  now=new Date();
  const xhr = new XMLHttpRequest();
  xhr.open("GET", "https://app.asana.com/api/1.0/tasks/"+gid);
  xhr.setRequestHeader("Authorization","Bearer 1/1200705207580012:7c048fb47ee9d3a9e832da53629595c4")
  xhr.responseType = "json";
  xhr.send();
  xhr.onload = () => {
    if (xhr.readyState == 4 && xhr.status == 200) {
      const resp = xhr.response;
      const data=resp.data
      console.log(gid,data)
      cfpplace=document.getElementById('cfplist');
      var row = cfpplace.insertRow(0);
      row.insertCell(0).innerHTML=!data.completed;
      row.insertCell(1).innerHTML=data.name;
      starton=data.start_on;
      if(starton==null) starton="?";
      dueon=data.due_on;

      if(dueon==null) dueon="?"

      row.insertCell(2).innerHTML=starton+"-"+dueon;

      if(data.due_on!=null) {
          then=new Date(data.due_on);
          var diff = then.getTime() - now.getTime();
          var days = diff / (1000 * 3600 * 24);
          row.insertCell(3).innerHTML=Math.round(days)
          if(days<1) {
            console.log(row);
            row.className="table-warning";
          }
      }
    }  else {
      console.log(`Error: ${xhr.status}`);
    }
  };
}
  function loadCFPTasks() {

    key=sessionStorage.getItem("dashboard-code");
    if(key==null) {
      console.log("not logged in");
      return;
    }
    const xhr = new XMLHttpRequest();
    xhr.open("GET", "https://app.asana.com/api/1.0/projects/1202890089938347/tasks");
    xhr.setRequestHeader("Authorization","Bearer "+key)
    xhr.responseType = "json";
    xhr.send();
    xhr.onload = () => {
      if (xhr.readyState == 4 && xhr.status == 200) {
        const resp = xhr.response;
        const data=resp.data

        for(i=0;i<data.length;i++) {
          getTask(data[i].gid);
        }
    } else {
      console.log(`Error: ${xhr.status}`);
    }
  };
}

  function checkIntro() {
// got a callback ?
const queryString = window.location.search;
console.log(queryString);
const urlParams = new URLSearchParams(queryString);
const code = urlParams.get('code')
console.log(code);
const state = urlParams.get('state')
console.log(state);

if(code!=null) {
  if(state==null) {
      return "illegal callback - no state";
  }
  var fudge=sessionStorage.getItem("dashboard-fudge");
  if(fudge==null) {
    return "illegal callback - didn't initiate";
  }
  // save the code
    sessionStorage.setItem("dashboard-code",code);
    return null;
}

// no code so assume not a callback.  Set a fudge factor
sessionStorage.setItem("dashboard-fudge",Math.floor(Math.random() * 10000000000000001));

if(sessionStorage.getItem("dashboard-code")==null) {
  if(fudge==null) {
    fudge=sessionStorage.getItem("dashboard-fudge");
    logButton=document.getElementById('signin');
    signin.innerHTML="<a class='button' href='https://app.asana.com/-/oauth_authorize?response_type=code&client_id=1203516656368369&redirect_uri=https%3A%2F%2Fgruffwizard.dev%2Fdashboard%2F&state="+fudge+"'>Sign in</a>";
  }
}
return null;
}

var check=checkIntro();

if(check!=null) {
console.log(check);

} else {
 loadCFPTasks();
}


</script>

  </body>
</html>
